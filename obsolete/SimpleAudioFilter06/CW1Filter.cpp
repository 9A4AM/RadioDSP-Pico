#include "CW1Filter.h"

static int filter_taps[CW1FILTER_TAP_NUM] = {
  -18,
  5,
  30,
  52,
  48,
  5,
  -62,
  -111,
  -102,
  -29,
  70,
  134,
  123,
  51,
  -24,
  -50,
  -26,
  -8,
  -56,
  -163,
  -237,
  -161,
  96,
  421,
  592,
  434,
  -32,
  -565,
  -836,
  -652,
  -102,
  483,
  755,
  588,
  154,
  -219,
  -305,
  -140,
  28,
  -26,
  -289,
  -508,
  -403,
  71,
  641,
  906,
  655,
  50,
  -486,
  -608,
  -338,
  -41,
  -87,
  -480,
  -778,
  -438,
  660,
  1946,
  2440,
  1452,
  -787,
  -3081,
  -3951,
  -2625,
  347,
  3324,
  4562,
  3324,
  347,
  -2625,
  -3951,
  -3081,
  -787,
  1452,
  2440,
  1946,
  660,
  -438,
  -778,
  -480,
  -87,
  -41,
  -338,
  -608,
  -486,
  50,
  655,
  906,
  641,
  71,
  -403,
  -508,
  -289,
  -26,
  28,
  -140,
  -305,
  -219,
  154,
  588,
  755,
  483,
  -102,
  -652,
  -836,
  -565,
  -32,
  434,
  592,
  421,
  96,
  -161,
  -237,
  -163,
  -56,
  -8,
  -26,
  -50,
  -24,
  51,
  123,
  134,
  70,
  -29,
  -102,
  -111,
  -62,
  5,
  48,
  52,
  30,
  5,
  -18
};

void CW1Filter_init(CW1Filter* f) {
  int i;
  for(i = 0; i < CW1FILTER_TAP_NUM; ++i)
    f->history[i] = 0;
  f->last_index = 0;
}

void CW1Filter_put(CW1Filter* f, int input) {
  f->history[f->last_index++] = input;
  if(f->last_index == CW1FILTER_TAP_NUM)
    f->last_index = 0;
}

int CW1Filter_get(CW1Filter* f) {
  long long acc = 0;
  int index = f->last_index, i;
  for(i = 0; i < CW1FILTER_TAP_NUM; ++i) {
    index = index != 0 ? index-1 : CW1FILTER_TAP_NUM-1;
    acc += (long long)f->history[index] * filter_taps[i];
  };
  return acc >> 16;
}
